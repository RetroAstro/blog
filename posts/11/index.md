### å‰è¨€

è‡ªå·±ç€æ‰‹å‡†å¤‡å†™è¿™ç¯‡æ–‡ç« çš„åˆè¡·æ˜¯è§‰å¾—å¦‚æœæƒ³è¦æ›´æ·±å…¥çš„ç†è§£ JSï¼Œå¼‚æ­¥ç¼–ç¨‹åˆ™æ˜¯å¿…é¡»è¦è·¨è¿‡çš„ä¸€é“åã€‚ç”±äºè¿™é‡Œé¢æ¶‰åŠåˆ°çš„ä¸œè¥¿å¾ˆå¤šä¹Ÿå¾ˆå¹¿ï¼Œåœ¨åˆå­¦ JS çš„æ—¶å€™å¯èƒ½æ— æ³•å®Œæ•´çš„ç†è§£è¿™ä¸€æ¦‚å¿µï¼Œå³ä½¿åœ¨ç°åœ¨æ¥çœ‹è¿˜æ˜¯æœ‰å¾ˆå¤šè‡ªå·±æ²¡æœ‰æ¥è§¦å’Œç†è§£åˆ°çš„çŸ¥è¯†ç‚¹ï¼Œä½†æ˜¯ä¸ºäº†è·¨è¿‡è¿™é“åï¼Œæˆ‘ä»ç„¶æ„¿æ„é¼“èµ·å‹‡æ°”ç”¨æˆ‘å·²ç»æŒæ¡çš„éƒ¨åˆ†çŸ¥è¯†å°½å…¨åŠ›è®²è¿°ä¸€ä¸‹ JS ä¸­çš„å¼‚æ­¥ç¼–ç¨‹ã€‚å¦‚æœæˆ‘æ‰€è®²çš„ä¸€äº›æ¦‚å¿µæˆ–æœ¯è¯­æœ‰é”™è¯¯ï¼Œè¯·è¯»è€…å‘æˆ‘æŒ‡å‡ºé—®é¢˜æ‰€åœ¨ï¼Œæˆ‘ä¼šç«‹å³çº æ­£æ›´æ”¹ã€‚

### åŒæ­¥ä¸å¼‚æ­¥

æˆ‘ä»¬çŸ¥é“æ— è®ºæ˜¯åœ¨æµè§ˆå™¨ç«¯è¿˜æ˜¯åœ¨æœåŠ¡å™¨ ( Node ) ç«¯ï¼ŒJS çš„æ‰§è¡Œéƒ½æ˜¯åœ¨å•çº¿ç¨‹ä¸‹è¿›è¡Œçš„ã€‚æˆ‘ä»¬ä»¥æµè§ˆå™¨ä¸­çš„ JS æ‰§è¡Œçº¿ç¨‹ä¸ºä¾‹ï¼Œåœ¨è¿™ä¸ªçº¿ç¨‹ä¸­ JS å¼•æ“ä¼šåˆ›å»ºæ‰§è¡Œä¸Šä¸‹æ–‡æ ˆï¼Œä¹‹åæˆ‘ä»¬çš„ä»£ç å°±ä¼šä½œä¸ºæ‰§è¡Œä¸Šä¸‹æ–‡ ( å…¨å±€ã€å‡½æ•°ã€eval ) åƒä¸€ç³»åˆ—ä»»åŠ¡ä¸€æ ·åœ¨æ‰§è¡Œä¸Šä¸‹æ–‡æ ˆä¸­æŒ‰ç…§åè¿›å…ˆå‡º ( LIFO ) çš„æ–¹å¼ä¾æ¬¡æ‰§è¡Œã€‚è€ŒåŒæ­¥æœ€å¤§çš„ç‰¹æ€§å°±æ˜¯ä¼šé˜»å¡åé¢ä»»åŠ¡çš„æ‰§è¡Œï¼Œæ¯”å¦‚æ­¤æ—¶ JS æ­£åœ¨æ‰§è¡Œå¤§é‡çš„è®¡ç®—ï¼Œè¿™ä¸ªæ—¶å€™å°±ä¼šä½¿çº¿ç¨‹é˜»å¡ä»è€Œå¯¼è‡´é¡µé¢æ¸²æŸ“åŠ è½½ä¸è¿è´¯ ( åœ¨æµè§ˆå™¨ç«¯çš„ Event Loop ä¸­æ¯æ¬¡æ‰§è¡Œæ ˆä¸­çš„ä»»åŠ¡æ‰§è¡Œå®Œæ¯•åéƒ½ä¼šå»æ£€æŸ¥å¹¶æ‰§è¡Œäº‹ä»¶é˜Ÿåˆ—é‡Œé¢çš„ä»»åŠ¡ç›´åˆ°é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ä¸ºç©ºï¼Œè€Œäº‹ä»¶é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡åˆåˆ†ä¸ºå¾®é˜Ÿåˆ—ä¸å®é˜Ÿåˆ—ï¼Œå½“å¾®é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡æ‰§è¡Œå®Œåæ‰ä¼šå»æ‰§è¡Œå®é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ï¼Œè€Œåœ¨å¾®é˜Ÿåˆ—ä»»åŠ¡æ‰§è¡Œå®Œåˆ°å®é˜Ÿåˆ—ä»»åŠ¡å¼€å§‹ä¹‹å‰æµè§ˆå™¨çš„ GUI çº¿ç¨‹ä¼šæ‰§è¡Œä¸€æ¬¡é¡µé¢æ¸²æŸ“ ( UI rendering )ï¼Œè¿™ä¹Ÿå°±è§£é‡Šäº†ä¸ºä»€ä¹ˆåœ¨æ‰§è¡Œæ ˆä¸­è¿›è¡Œå¤§é‡çš„è®¡ç®—æ—¶ä¼šé˜»å¡é¡µé¢çš„æ¸²æŸ“ ) ã€‚

ä¸åŒæ­¥ç›¸å¯¹çš„å¼‚æ­¥åˆ™å¯ä»¥ç†è§£ä¸ºåœ¨å¼‚æ­¥æ“ä½œå®Œæˆåæ‰€è¦åšçš„ä»»åŠ¡ï¼Œå®ƒä»¬é€šå¸¸ä»¥å›è°ƒå‡½æ•°æˆ–è€… Promise çš„å½¢å¼è¢«æ”¾å…¥äº‹ä»¶é˜Ÿåˆ—ï¼Œå†ç”±äº‹ä»¶å¾ªç¯ ( Event Loop ) æœºåˆ¶åœ¨æ¯æ¬¡è½®è¯¢æ—¶æ£€æŸ¥å¼‚æ­¥æ“ä½œæ˜¯å¦å®Œæˆï¼Œè‹¥å®Œæˆåˆ™æŒ‰äº‹ä»¶é˜Ÿåˆ—é‡Œé¢çš„æ‰§è¡Œè§„åˆ™æ¥ä¾æ¬¡æ‰§è¡Œç›¸åº”çš„ä»»åŠ¡ã€‚ä¹Ÿæ­£æ˜¯å¾—ç›Šäºäº‹ä»¶å¾ªç¯æœºåˆ¶çš„å­˜åœ¨ï¼Œæ‰ä½¿å¾—å¼‚æ­¥ä»»åŠ¡ä¸ä¼šåƒåŒæ­¥ä»»åŠ¡é‚£æ ·å®Œå…¨é˜»å¡ JS æ‰§è¡Œçº¿ç¨‹ã€‚

å¼‚æ­¥æ“ä½œä¸€èˆ¬åŒ…æ‹¬  **ç½‘ç»œè¯·æ±‚** ã€**æ–‡ä»¶è¯»å–** ã€**æ•°æ®åº“å¤„ç†**

å¼‚æ­¥ä»»åŠ¡ä¸€èˆ¬åŒ…æ‹¬  **setTimout / setInterval** ã€**Promise** ã€**requestAnimationFrame ( æµè§ˆå™¨ç‹¬æœ‰ )** ã€**setImmediate ( Node ç‹¬æœ‰ )** ã€**process.nextTick ( Node ç‹¬æœ‰ )** ã€**etc ...**

> **æ³¨æ„ï¼š** åœ¨æµè§ˆå™¨ç«¯ä¸åœ¨ Node ç«¯çš„ Event Loop æœºåˆ¶æ˜¯æœ‰æ‰€ä¸åŒçš„ï¼Œä¸‹é¢ç»™å‡ºçš„ä¸¤å¼ å›¾ç®€è¦é˜è¿°äº†åœ¨ä¸åŒç¯å¢ƒä¸‹äº‹ä»¶å¾ªç¯çš„è¿è¡Œæœºåˆ¶ï¼Œç”±äº Event Loop ä¸æ˜¯æœ¬æ–‡å†…å®¹çš„é‡ç‚¹ï¼Œä½†æ˜¯ JS å¼‚æ­¥ç¼–ç¨‹åˆæ˜¯å»ºç«‹åœ¨å®ƒçš„åŸºç¡€ä¹‹ä¸Šçš„ï¼Œæ•…åœ¨ä¸‹é¢ç»™å‡ºç›¸åº”çš„é˜…è¯»é“¾æ¥ï¼Œå¸Œæœ›èƒ½å¤Ÿå¸®åŠ©åˆ°æœ‰éœ€è¦çš„è¯»è€…ã€‚

**æµè§ˆå™¨ç«¯**

![](https://s1.ax1x.com/2018/10/25/iym7Bq.png)

**Node ç«¯**

![](https://s1.ax1x.com/2018/10/25/iymcHP.png)

**é˜…è¯»é“¾æ¥**

* **[æ·±å…¥ç†è§£ JS äº‹ä»¶å¾ªç¯æœºåˆ¶ ( æµè§ˆå™¨ç¯‡ )](http://lynnelv.github.io/js-event-loop-browser)**
* **[æ·±å…¥ç†è§£ JS äº‹ä»¶å¾ªç¯æœºåˆ¶ ( Node.js ç¯‡ )](http://lynnelv.github.io/js-event-loop-nodejs)**

### ä¸ºå¼‚æ­¥è€Œç”Ÿçš„ JS è¯­æ³•

å›æœ›å†å²ï¼Œåœ¨æœ€è¿‘å‡ å¹´é‡Œ ECMAScript æ ‡å‡†å‡ ä¹æ¯å¹´éƒ½æœ‰ç‰ˆæœ¬çš„æ›´æ–°ï¼Œä¹Ÿæ­£æ˜¯å› ä¸ºæœ‰åƒ ES6 è¿™ç§åœ¨è¯­è¨€ç‰¹æ€§ä¸Šå¤§ç‰ˆæœ¬çš„æ›´æ–°ï¼Œåˆ°äº†ç°ä»Šçš„ 8102 å¹´ï¼Œ JS ä¸­çš„å¼‚æ­¥ç¼–ç¨‹ç›¸å¯¹äºé‚£ä¸ªåªæœ‰å›è°ƒå‡½æ•°çš„è¿œå¤æ—¶ä»£æœ‰äº†å¾ˆå¤§çš„è¿›æ­¥ã€‚ä¸‹é¢æˆ‘å°†ä»‹ç» callback ã€Promise ã€generator ã€async / await çš„åŸºæœ¬ç”¨æ³•ä»¥åŠå¦‚ä½•åœ¨å¼‚æ­¥ç¼–ç¨‹ä¸­ä½¿ç”¨å®ƒä»¬ã€‚

#### callback

å›è°ƒå‡½æ•°å¹¶ä¸ç®—æ˜¯ JS ä¸­çš„è¯­æ³•ä½†å®ƒå´æ˜¯è§£å†³å¼‚æ­¥ç¼–ç¨‹é—®é¢˜ä¸­æœ€å¸¸ç”¨çš„ä¸€ç§æ–¹æ³•ï¼Œæ‰€ä»¥åœ¨è¿™é‡Œæœ‰å¿…è¦æå‡ºæ¥ï¼Œä¸‹é¢ä¸¾ä¸€ä¸ªä¾‹å­ï¼Œå¤§å®¶çœ‹ä¸€çœ¼å°±æ‡‚ã€‚

```js
const foo = function (x, y, cb) {
    setTimeout(() => {
        cb(x + y)
    }, 2000)
}

// ä½¿ç”¨ thunk å‡½æ•°ï¼Œæœ‰ç‚¹å‡½æ•°æŸ¯é‡ŒåŒ–çš„å‘³é“ï¼Œåœ¨æœ€åå¤„ç† callbackã€‚
const thunkify = function (fn) {
    return function () {
        let args = Array.from(arguments)
        return function (cb) {
            fn.apply(null, [...args, cb])
        }
    }
}

let fooThunkory = thunkify(foo)

let fooThunk1 = fooThunkory(2, 8)
let fooThunk2 = fooThunkory(4, 16)

fooThunk1((sum) => {
    console.log(sum) // 10
})

fooThunk2((sum) => {
    console.log(sum) // 20
})
```

#### Promise

åœ¨ ES6 æ²¡æœ‰å‘å¸ƒä¹‹å‰ï¼Œä½œä¸ºå¼‚æ­¥ç¼–ç¨‹ä¸»åŠ›å†›çš„å›è°ƒå‡½æ•°ä¸€ç›´è¢«äººè¯Ÿç—…ï¼Œå…¶åŸå› æœ‰å¤ªå¤šæ¯”å¦‚å›è°ƒåœ°ç‹±ã€ä»£ç æ‰§è¡Œé¡ºåºéš¾ä»¥è¿½è¸ªã€åæœŸå› ä»£ç å˜å¾—ååˆ†å¤æ‚å¯¼è‡´æ— æ³•ç»´æŠ¤å’Œæ›´æ–°ç­‰ï¼Œè€Œ Promise çš„å‡ºç°åœ¨å¾ˆå¤§ç¨‹åº¦ä¸Šæ”¹å˜äº†ä¹‹å‰çš„çª˜å¢ƒã€‚è¯ä¸å¤šè¯´å…ˆç›´æ¥ä¸Šä»£ç æå‰æ„Ÿå—ä¸‹å®ƒçš„é­…åŠ›ï¼Œç„¶åæˆ‘å†æ€»ç»“ä¸‹è‡ªå·±è®¤ä¸ºåœ¨ Promise ä¸­å¾ˆé‡è¦çš„å‡ ä¸ªç‚¹ã€‚

```js
const foo = function () {
    let args = [...arguments]
    let cb = args.pop()
    setTimeout(() => {
        cb(...args)
    }, 2000)
}

const promisify = function (fn) {
    return function () {
        let args = [...arguments]
        return function (cb) {
            return new Promise((resolve, reject) => {
                fn.apply(null, [...args, resolve, reject, cb])
            })
        }
    }
}

const callback = function (x, y, isAdd, resolve, reject) {
    if (isAdd) {
        resolve(x + y)
    } else {
        reject('Add is not allowed.')
    }
}

let promisory = promisify(foo)

let p1 = promisory(4, 16, false)
let p2 = promisory(2, 8, true)

p1(callback)
.then((sum) => {
    console.log(sum)
}, (err) => {
    console.error(err) // Add is not allowed.
})
.finally(() => {
    console.log('Triggered once the promise is settled.')
})

p2(callback)
.then((sum) => {
    console.log(sum) // 10
    return 'evil ğŸ˜¡'
})
.then((unknown) => {
    throw new Error(unknown)
})
.catch((err) => {
    console.error(err) // Error: evil ğŸ˜¡
})
```

**è¦ç‚¹ä¸€ï¼šåæ§åˆ¶åè½¬ ( å…³æ³¨ç‚¹åˆ†ç¦» )**

ä»€ä¹ˆæ˜¯åæ§åˆ¶åè½¬å‘¢ï¼Ÿè¦ç†è§£å®ƒæˆ‘ä»¬åº”è¯¥å…ˆå¼„æ¸…æ¥šæ§åˆ¶åè½¬çš„å«ä¹‰ï¼Œæ¥çœ‹ä¸€æ®µä¼ªä»£ç ã€‚

```js
const request = require('request')

// æŸè´­ç‰©ç³»ç»Ÿè·å–ç”¨æˆ·å¿…è¦ä¿¡æ¯åæ‰§è¡Œæ”¶è´¹æ“ä½œ
const purchase = function (url) {
    request(url, (err, response, data) => {
        if (err) return console.error(err)
        if (response.statusCode === 200) {
            chargeUser(data)
        }
    })
}

purchase('https://cosmos-alien.com/api/getUserInfo')
```

æ˜¾ç„¶åœ¨è¿™é‡Œ `request` æ¨¡å—å±äºç¬¬ä¸‰æ–¹åº“æ˜¯ä¸èƒ½å¤Ÿå®Œå…¨ä¿¡ä»»çš„ï¼Œå‡å¦‚æŸä¸€å¤©è¯¥æ¨¡å—å‡ºäº† `bug` , åŸæœ¬åªä¼šå‘ç›®æ ‡ `url` å‘é€ä¸€æ¬¡è¯·æ±‚å´å˜æˆäº†å¤šæ¬¡ï¼Œç›¸åº”çš„æˆ‘ä»¬çš„ `chargeUser` å‡½æ•°ä¹Ÿå°±æ˜¯æ”¶è´¹æ“ä½œå°±ä¼šè¢«æ‰§è¡Œå¤šæ¬¡ï¼Œæœ€ç»ˆå¯¼è‡´ç”¨æˆ·è¢«å¤šæ¬¡æ”¶è´¹ï¼Œè¿™æ ·çš„ç»“æœå®Œå…¨å°±æ˜¯å™©æ¢¦ï¼ç„¶è€Œè¿™å°±æ˜¯æ§åˆ¶åè½¬ï¼Œå³æŠŠè‡ªå·±çš„ä»£ç äº¤ç»™ç¬¬ä¸‰æ–¹æŒæ§ï¼Œå› æ­¤æ˜¯ä¸å¯å®Œå…¨ä¿¡ä»»çš„ã€‚

é‚£ä¹ˆåæ§åˆ¶åè½¬ç°åœ¨æˆ‘ä»¬å¯ä»¥çŒœæµ‹å®ƒçš„å«ä¹‰åº”è¯¥å°±æ˜¯å°†æ§åˆ¶æƒäº¤è¿˜åˆ°æˆ‘ä»¬è‡ªå·±å†™çš„ä»£ç ä¸­ï¼Œè€Œè¦å®ç°è¿™ç‚¹é€šå¸¸æˆ‘ä»¬ä¼šå¼•å…¥ä¸€ä¸ªç¬¬ä¸‰æ–¹åå•†æœºåˆ¶ï¼Œåœ¨ `Promise` ä¹‹å‰æˆ‘ä»¬ä¼šé€šè¿‡äº‹ä»¶ç›‘å¬çš„å½¢å¼æ¥è§£å†³è¿™ç±»é—®é¢˜ã€‚ç°åœ¨æˆ‘ä»¬å°†ä»£ç æ›´æ”¹å¦‚ä¸‹ï¼š

```js
const request = require('request')
const events = require('events')

const listener = new events.EventEmitter()

listener.on('charge', (data) => {
    chargeUser(data)
})

const purchase = function (url) {
    request(url, (err, response, data) => {
        if (err) return console.error(err)
        if (response.statusCode === 200) {
            listener.emit('charge', data)
        }
    })
}

purchase('https://cosmos-alien.com/api/getUserInfo')
```

æ›´æ”¹ä»£ç ä¹‹åæˆ‘ä»¬ä¼šå‘ç°æ§åˆ¶åè½¬çš„æ¢å¤å…¶å®æ˜¯æ›´å¥½çš„å®ç°äº†å…³æ³¨ç‚¹åˆ†ç¦»ï¼Œæˆ‘ä»¬ä¸ç”¨å»å…³å¿ƒ `purchase` å‡½æ•°å†…éƒ¨å…·ä½“å‘ç”Ÿäº†ä»€ä¹ˆï¼Œåªéœ€è¦çŸ¥é“å®ƒåœ¨ä»€ä¹ˆæ—¶å€™å®Œæˆï¼Œä¹‹åæˆ‘ä»¬çš„å…³æ³¨ç‚¹å°±ä» `purchase` å‡½æ•°è½¬ç§»åˆ°äº† `listener` å¯¹è±¡ä¸Šã€‚æˆ‘ä»¬å¯ä»¥æŠŠ `listener` å¯¹è±¡æä¾›ç»™ä»£ç ä¸­å¤šä¸ªç‹¬ç«‹çš„éƒ¨åˆ†ï¼Œåœ¨ `purchase` å‡½æ•°å®Œæˆåï¼Œå®ƒä»¬åŒæ ·ä¹Ÿèƒ½æ”¶åˆ°é€šçŸ¥å¹¶è¿›è¡Œä¸‹ä¸€æ­¥çš„æ“ä½œã€‚ä»¥ä¸‹æ˜¯ç»´åŸºç™¾ç§‘ä¸Šå…³äºå…³æ³¨ç‚¹åˆ†ç¦»çš„ä¸€éƒ¨åˆ†ä»‹ç»ã€‚

> å…³æ³¨ç‚¹åˆ†ç¦»çš„ä»·å€¼åœ¨äºç®€åŒ–è®¡ç®—æœºç¨‹åºçš„å¼€å‘å’Œç»´æŠ¤ã€‚å½“å…³æ³¨ç‚¹åˆ†å¼€æ—¶ï¼Œå„éƒ¨åˆ†å¯ä»¥é‡å¤ä½¿ç”¨ï¼Œä»¥åŠç‹¬ç«‹å¼€å‘å’Œæ›´æ–°ã€‚å…·æœ‰ç‰¹æ®Šä»·å€¼çš„æ˜¯èƒ½å¤Ÿç¨åæ”¹è¿›æˆ–ä¿®æ”¹ä¸€æ®µä»£ç ï¼Œè€Œæ— éœ€çŸ¥é“å…¶ä»–éƒ¨åˆ†çš„ç»†èŠ‚å¿…é¡»å¯¹è¿™äº›éƒ¨åˆ†è¿›è¡Œç›¸åº”çš„æ›´æ”¹ã€‚
>
> *ä¸€ä¸€    ç»´åŸºç™¾ç§‘*

æ˜¾ç„¶åœ¨ `Promise` ä¸­ `new Promise()` è¿”å›çš„å¯¹è±¡å°±æ˜¯å…³æ³¨ç‚¹åˆ†ç¦»ä¸­åˆ†ç¦»å‡ºæ¥çš„é‚£ä¸ªå…³æ³¨å¯¹è±¡ã€‚

**è¦ç‚¹äºŒï¼šä¸å¯å˜æ€§ ( å€¼å¾—ä¿¡ä»» )**

ç»†å¿ƒçš„è¯»è€…å¯èƒ½ä¼šå‘ç°ï¼Œè¦ç‚¹ä¸€ä¸­åŸºäºäº‹ä»¶ç›‘å¬çš„åæ§åˆ¶åè½¬ä»ç„¶æ²¡æœ‰è§£å†³æœ€é‡è¦çš„ä¿¡ä»»é—®é¢˜ï¼Œæ”¶è´¹æ“ä½œä»æ—§å¯ä»¥å› ä¸ºç¬¬ä¸‰æ–¹ API çš„å¤šæ¬¡è°ƒç”¨è€Œè¢«è§¦å‘ä¸”æ‰§è¡Œå¤šæ¬¡ã€‚å¹¸è¿çš„æ˜¯ç°åœ¨æˆ‘ä»¬æ‹¥æœ‰ `Promise` è¿™æ ·å¼ºå¤§çš„æœºåˆ¶ï¼Œæ‰å¾—ä»¥è®©æˆ‘ä»¬ä»ä¿¡ä»»å±æœºä¸­è§£è„±å‡ºæ¥ã€‚æ‰€è°“ä¸å¯å˜æ€§å°±æ˜¯ï¼š

**Promise åªèƒ½è¢«å†³è®®ä¸€æ¬¡ï¼Œå¦‚æœä»£ç ä¸­è¯•å›¾å¤šæ¬¡è°ƒç”¨ `resolve(..)` æˆ–è€… `reject(..)` ï¼ŒPromise åªä¼šæ¥å—ç¬¬ä¸€æ¬¡å†³è®®ï¼Œå†³è®®åå°±æ˜¯å¤–éƒ¨ä¸å¯å˜çš„å€¼ï¼Œå› æ­¤ä»»ä½•é€šè¿‡ `then(..)` æ³¨å†Œçš„å›è°ƒåªä¼šè¢«è°ƒç”¨ä¸€æ¬¡ã€‚**

ç°åœ¨è¦ç‚¹ä¸€ä¸­çš„ç¤ºä¾‹ä»£ç å°±å¯ä»¥æœ€ç»ˆæ›´æ”¹ä¸ºï¼š

```js
const request = require('request')

const purchase = function (url) {
    return new Promise((resolve, reject) => {
        request(url, (err, response, data) => {
            if (err) reject(err)
            if (response.statusCode === 200) {
                resolve(data)
            }
        })
    })
}

purchase('https://cosmos-alien.com/api/getUserInfo')
.then((data) => {
    chargeUser(data)
})
.catch((err) => {
    console.error(err)
})
```

**è¦ç‚¹ä¸‰ï¼šé”™è¯¯å¤„ç†åŠä¸€äº›ç»†èŠ‚**

è¿˜è®°å¾—æœ€å¼€å§‹è®² Promise æ—¶çš„é‚£ä¸€æ®µä»£ç å—ï¼Ÿæˆ‘ä»¬æŠŠæ‰“å°ç»“æœçš„é‚£éƒ¨åˆ†ä»£ç å†æ¬¡æ‹¿å‡ºæ¥çœ‹çœ‹ã€‚

```js
p1(callback)
.then((sum) => {
    console.log(sum)
}, (err) => {
    console.error(err) // Add is not allowed.
})
.finally(() => {
    console.log('Triggered once the promise is settled.')
})

p2(callback)
.then((sum) => {
    console.log(sum) // 10
    return 'evil ğŸ˜¡'
})
.then((unknown) => {
    throw new Error(unknown)
})
.catch((err) => {
    console.error(err) // Error: evil ğŸ˜¡
})
```

é¦–å…ˆæˆ‘ä»¬è¯´ä¸‹ `then(..)` ï¼Œå®ƒçš„ç¬¬ä¸€ä¸ªå‚æ•°ä½œä¸ºå‡½æ•°æ¥æ”¶ `promise` å¯¹è±¡ä¸­ `resolve(..)` çš„å€¼ï¼Œç¬¬äºŒä¸ªå‚æ•°åˆ™ä½œä¸ºé”™è¯¯å¤„ç†å‡½æ•°å¤„ç†åœ¨ Promise ä¸­å¯èƒ½å‘ç”Ÿçš„é”™è¯¯ã€‚

è€Œåœ¨ Promise ä¸­æœ‰ä¸¤ç§é”™è¯¯å¯èƒ½ä¼šå‡ºç°ï¼Œä¸€ç§æ˜¯æ˜¾å¼ `reject(..)` æŠ›å‡ºçš„é”™è¯¯ï¼Œå¦ä¸€ç§åˆ™æ˜¯ä»£ç è‡ªèº«æœ‰é”™è¯¯ä¼šè¢« Promise æ•æ‰ï¼Œé€šè¿‡ `then(..)` ä¸­çš„é”™è¯¯å¤„ç†å‡½æ•°æˆ‘ä»¬å¯ä»¥æ¥æ”¶åˆ°å®ƒå‰é¢ `promise` å¯¹è±¡ä¸­å‡ºç°çš„é”™è¯¯ï¼Œè€Œå¦‚æœåœ¨ `then(..)` æ¥æ”¶ `resolve(..)` å€¼çš„å‡½æ•°ä¸­ä¹Ÿå‡ºç°é”™è¯¯ï¼Œè¯¥é”™è¯¯åˆ™ä¼šè¢«ä¸‹ä¸€ä¸ª `then(..)` çš„é”™è¯¯å¤„ç†å‡½æ•°æ‰€æ¥æ”¶ ( æœ‰ä¸¤ä¸ªå‰æï¼Œç¬¬ä¸€æ˜¯è¦å†™å‡ºè¿™ä¸ª `then(..)` å¦åˆ™è¯¥é”™è¯¯æœ€ç»ˆä¼šåœ¨å…¨å±€æŠ›å‡ºï¼Œç¬¬äºŒä¸ªåˆ™æ˜¯è¦ç¡®ä¿å‰ä¸€ä¸ª `then(..)` åœ¨å®ƒçš„ Promise å†³è®®åè°ƒç”¨çš„æ˜¯ç¬¬ä¸€ä¸ªå‚æ•°å³æ¥æ”¶ `resolve(..)` å€¼çš„å‡½æ•°è€Œä¸æ˜¯é”™è¯¯å¤„ç†å‡½æ•° )ã€‚

ä¸€äº›å€¼å¾—æ³¨æ„çš„ç»†èŠ‚ï¼š

`catch(..)` ç›¸å½“äº `then(..)` ä¸­çš„é”™è¯¯å¤„ç†å‡½æ•° ï¼Œåªæ˜¯çœç•¥äº†ç¬¬ä¸€ä¸ªå‚æ•°ã€‚

`finally(..)` åœ¨ Promise ä¸€æ—¦å†³è®®å ( æ— è®ºæ˜¯ `resolve` è¿˜æ˜¯ `reject` ) éƒ½ä¼šè¢«æ‰§è¡Œã€‚

`then(..)` ã€`catch(..)` ã€`finally(..)` éƒ½æ˜¯å¼‚æ­¥è°ƒç”¨ï¼Œä½œä¸º Event Loop é‡Œäº‹ä»¶é˜Ÿåˆ—ä¸­çš„å¾®é˜Ÿåˆ—ä»»åŠ¡æ‰§è¡Œã€‚

**è¡¥å……ï¼šæ‰‹å†™ä¸€ä¸ª Promise**

```js
function iPromise(fn) {
    let state = 'pending',
        value = null,
        error = null,
        callbacks = []

    this.then = function (onFulfilled, onRejected) {
        return new iPromise((resolve, reject) => {
            transition({
                onFulfilled: onFulfilled,
                onRejected: onRejected,
                resolve: resolve,
                reject: reject
            })
        })
    }

    function transition(callback) {
        let result
        switch (state) {
            case 'pending':
                callbacks.push(callback)
                return
            case 'resolved':
                try {
                    if (callback.onFulfilled) result = callback.onFulfilled(value)
                } catch (e) {
                    if (callback.onRejected) result = callback.onRejected(e)
                }
                break
            case 'rejected':
                if (callback.onRejected) result = callback.onRejected(error)
                break
        }
        if (result instanceof iPromise) {
            result.then(callback.resolve, callback.reject)
            return
        }
        state === 'resolved' ? callback.resolve(result) : callback.reject(result)
    }

    function resolve(newValue) {
        state = 'resolved'
        value = newValue
        execute()
    }

    function reject(err) {
        state = 'rejected'
        error = err
        execute()
    }

    function execute() {
        callbacks.length ? callbacks.map(callback => transition(callback)) : null
    }

    fn(resolve, reject)
}

var p = new iPromise((resolve) => {
    setTimeout(() => resolve(2333), 1000)
})

p.then(res =>
    new iPromise((resolve) => {
        setTimeout(() => {
            resolve(res)
        }, 2000)
    })
).then(res =>
    new iPromise((resolve, reject) => {
        reject(res)
    })
).then(null, err => console.error(err)) // 2333
```

å¯ä»¥çœ‹åˆ°å®ç° Promise çš„å…³é”®å°±æ˜¯ä¸ºå…¶è®¾ç½® `pending` ã€`resolved` ã€`rejected` ä¸‰ç§çŠ¶æ€ï¼Œè€Œä¸”åªèƒ½ç”± `pending` è½¬æ¢åˆ° `resolved` æˆ–è€… `rejected` ã€‚éœ€è¦æ³¨æ„çš„æ˜¯æˆ‘ä»¬ç”¨ `then(..)` æ³¨å†Œçš„é‚£äº›å›è°ƒå‡½æ•°æ—©åœ¨æ‰§è¡ŒåŒæ­¥ä»£ç çš„æ—¶å€™å°±å·²ç»è¢«ç¼“å­˜åœ¨å¯¹åº” Promise ä¸­çš„ `callbacks` æ•°ç»„é‡Œ ( å¦‚æœæ­¤æ—¶çš„çŠ¶æ€ä¸º `pending` )ï¼Œå½“å¼‚æ­¥æ“ä½œå®Œæˆåæˆ‘ä»¬æ‰§è¡Œä» Promise ä¼ é€’å‡ºæ¥çš„ `resolve` æˆ–è€… `rejected` å‡½æ•°å»è§¦å‘ `callbacks` æ•°ç»„ä¸­ç›¸åº”å‡½æ•°çš„æ‰§è¡Œã€‚æˆ‘ä»¬è¿˜ä¼šå‘ç° `then(..)` æ–¹æ³•æ˜¯é“¾å¼è°ƒç”¨çš„ï¼Œå³åœ¨ Promise å†…éƒ¨å½“å‰ä¸€ä¸ª Promise çš„ `then(..)` æ³¨å†Œçš„å›è°ƒå‡½æ•°æ‰§è¡Œå®Œåå°±ä¼šè‡ªåŠ¨è°ƒç”¨ä¸‹ä¸€ä¸ª Promise ä¸­çš„ `resolve` å‡½æ•°ï¼Œç„¶åå†å»æ‰§è¡Œè¯¥ Promise ä¸­ `callbacks` æ•°ç»„é‡Œç¼“å­˜çš„å›è°ƒå‡½æ•°ã€‚

#### generator

generator ä¹Ÿå«åšç”Ÿæˆå™¨ï¼Œå®ƒæ˜¯ ES6 ä¸­å¼•å…¥çš„ä¸€ç§æ–°çš„å‡½æ•°ç±»å‹ï¼Œåœ¨å‡½æ•°å†…éƒ¨å®ƒå¯ä»¥å¤šæ¬¡å¯åŠ¨å’Œæš‚åœï¼Œä»è€Œå½¢æˆé˜»å¡åŒæ­¥çš„ä»£ç ã€‚ä¸‹é¢æˆ‘å°†å…ˆè®²è¿°å®ƒçš„åŸºæœ¬ç”¨æ³•ç„¶åæ˜¯å®ƒåœ¨å¼‚æ­¥ç¼–ç¨‹ä¸­çš„ä½¿ç”¨æœ€åä¼šç®€å•æ¢ç©¶ä¸€ä¸‹å®ƒçš„å·¥ä½œåŸç†ã€‚

**ç”Ÿæˆå™¨åŸºæœ¬ç”¨æ³•** 

```js
let a = 2

const foo = function *(x, y) {
    let b = (yield x) + a
    let c = (yield y) + b
    console.log(a + b + c)
}

let it = foo(6, 8)

let x = it.next().value
a++
let y = it.next(x * 5).value
a++

it.next(x + y) // 84
```

ä»ä¸Šé¢çš„ä»£ç æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ä¸æ™®é€šçš„å‡½æ•°ä¸åŒï¼Œç”Ÿæˆå™¨å‡½æ•°æ‰§è¡Œåè¿”å›çš„æ˜¯ä¸€ä¸ªè¿­ä»£å™¨å¯¹è±¡ï¼Œç”¨æ¥æ§åˆ¶ç”Ÿæˆå™¨çš„æš‚åœå’Œå¯åŠ¨ã€‚åœ¨å¸¸è§çš„è®¾è®¡æ¨¡å¼ä¸­å°±æœ‰ä¸€ç§æ¨¡å¼å«åšè¿­ä»£å™¨æ¨¡å¼ï¼Œå®ƒæŒ‡çš„æ˜¯æä¾›ä¸€ç§æ–¹æ³•é¡ºåºè®¿é—®ä¸€ä¸ªèšåˆå¯¹è±¡ä¸­çš„å„ä¸ªå…ƒç´ ï¼Œè€Œåˆä¸éœ€è¦æš´éœ²è¯¥å¯¹è±¡çš„å†…éƒ¨è¡¨ç¤ºã€‚è¿­ä»£å™¨å¯¹è±¡ `it` åŒ…å«ä¸€ä¸ª `next(..)` æ–¹æ³•ä¸”åœ¨è°ƒç”¨ä¹‹åè¿”å›ä¸€ä¸ª `{ done: .. , value: .. }` å¯¹è±¡ï¼Œç°åœ¨æˆ‘ä»¬å…ˆæ¥è‡ªå·±å®ç°ä¸€ä¸ªç®€å•çš„è¿­ä»£å™¨ã€‚

```js
const iterator = function (obj) {
    let current = -1
    return {
        [Symbol.iterator]() {
            return this
        },
        next() {
            current++
            return { done: current < obj.length ? false : true, value: obj[current] }
        }
    }
}

let it1 = iterator([1,2,3,4])

it1.next().value // 1
it1.next().value // 2
it1.next().value // 3
it1.next().value // 4

let it2 = iterator([5,6,7,8])

for (let v of it2) { console.log(v) } // 5 6 7 8
```

å¯ä»¥çœ‹åˆ°æˆ‘ä»¬è‡ªå·±å®ç°çš„è¿­ä»£å™¨ä¸ä»…èƒ½å¤Ÿæ‰‹åŠ¨è¿›è¡Œè¿­ä»£ï¼Œè¿˜èƒ½è¢« `for..of` è‡ªåŠ¨è¿­ä»£å±•å¼€ï¼Œè¿™æ˜¯å› ä¸ºåœ¨ ES6 ä¸­åªè¦å¯¹è±¡å…·æœ‰ `Symbol.iterator` å±æ€§ä¸”è¯¥å±æ€§è¿”å›çš„æ˜¯ä¸€ä¸ªè¿­ä»£å™¨å¯¹è±¡ï¼Œå°±èƒ½å¤Ÿè¢« `for..of` æ‰€æ¶ˆè´¹ã€‚

å›å¤´æ¥çœ‹æœ€å¼€å§‹çš„é‚£ä¸ª generator ç¤ºä¾‹ä»£ç ä¸­ç”Ÿæˆå™¨äº§ç”Ÿçš„è¿­ä»£å™¨å¯¹è±¡ `it` ï¼Œä¼¼ä¹å®ƒæ¯”æ™®é€šçš„è¿­ä»£å™¨æœ‰ç€æ›´å¼ºå¤§çš„åŠŸèƒ½ï¼Œå…¶å®å°±æ˜¯ä¸ `yield` è¡¨è¾¾å¼ç´§å¯†ç›¸è¿çš„**æ¶ˆæ¯åŒå‘ä¼ é€’**ã€‚ç°åœ¨æˆ‘å…ˆæ¥æ€»ç»“ä¸€ä¸‹è‡ªå·±è®¤ä¸ºåœ¨ç”Ÿæˆå™¨ä¸­ååˆ†é‡è¦çš„ç‚¹ï¼Œç„¶åå†æ¥åˆ†æä¸‹é‚£æ®µç¤ºä¾‹ä»£ç çš„å®Œæ•´æ‰§è¡Œè¿‡ç¨‹ã€‚

**æ¯æ¬¡è°ƒç”¨ `it.next()` åç”Ÿæˆå™¨å‡½æ•°å†…çš„ä»£ç å°±ä¼šå¯åŠ¨æ‰§è¡Œä¸”è¿”å›ä¸€ä¸ª `{ done: .. , value: .. }` å¯¹è±¡ï¼Œä¸€æ—¦é‡åˆ° `yield` è¡¨è¾¾å¼å°±ä¼šæš‚åœæ‰§è¡Œï¼Œå¦‚æœæ­¤æ—¶ `yield` è¡¨è¾¾å¼åé¢è·Ÿæœ‰å€¼ä¾‹å¦‚ `yield val`ï¼Œé‚£ä¹ˆè¿™ä¸ª `val` å°±ä¼šè¢«ä¼ å…¥è¿”å›å¯¹è±¡ä¸­é”®å `value` å¯¹åº”çš„é”®å€¼ï¼Œå½“å†æ¬¡è°ƒç”¨ `it.next()` æ—¶ `yield` çš„æš‚åœæ•ˆæœå°±ä¼šè¢«å–æ¶ˆï¼Œå¦‚æœæ­¤æ—¶çš„ `next` ä¸ºå½¢å¦‚ `it.next(val)` çš„è°ƒç”¨ï¼Œ`yield` è¡¨è¾¾å¼å°±ä¼šè¢« `val` æ‰€æ›¿æ¢ã€‚è¿™å°±æ˜¯ç”Ÿæˆå™¨å†…éƒ¨ä¸è¿­ä»£å™¨å¯¹è±¡å¤–éƒ¨ä¹‹é—´çš„æ¶ˆæ¯åŒå‘ä¼ é€’ã€‚**

å¼„æ¸…äº†ç”Ÿæˆå™¨ä¸­é‡è¦çš„ç‰¹æ€§åè¦ç†è§£å¼€å¤´çš„é‚£æ®µä»£ç å°±ä¸éš¾äº†ï¼Œé¦–å…ˆæ‰§è¡Œç¬¬ä¸€ä¸ª `it.next().value` ï¼Œé‡åˆ°ç¬¬ä¸€ä¸ª `yield` åç”Ÿæˆå™¨æš‚åœæ‰§è¡Œï¼Œæ­¤æ—¶å˜é‡ `x` æ¥å—åˆ°çš„å€¼ä¸º 6ã€‚åœ¨å…¨å±€ç¯å¢ƒä¸‹æ‰§è¡Œ `a++` åå†æ¬¡æ‰§è¡Œ `it.next(x * 5).value` ç”Ÿæˆå™¨ç»§ç»­æ‰§è¡Œä¸”ä¼ å…¥å€¼ 30ï¼Œå› æ­¤å˜é‡ `b` çš„å€¼å°±ä¸º 33ï¼Œå½“é‡åˆ°ç¬¬äºŒä¸ª `yield` åç”Ÿæˆå™¨åˆæš‚åœæ‰§è¡Œï¼Œå¹¶ä¸”å°†å€¼ 8 ä¼ å‡ºç»™å˜é‡ `y` ã€‚å†æ¬¡æ‰§è¡Œ `a++` ï¼Œç„¶åæ‰§è¡Œ `it.next(x + y)` æ¢å¤ç”Ÿæˆå™¨æ‰§è¡Œå¹¶ä¼ å…¥å€¼ 14ï¼Œæ­¤æ—¶å˜é‡ `c` çš„å€¼å°±ä¸º 47ï¼Œæœ€ç»ˆè®¡ç®— `a + b + c` ä¾¿å¯å¾—åˆ°å€¼ 84ã€‚

**åœ¨å¼‚æ­¥ç¼–ç¨‹ä¸­ä½¿ç”¨ç”Ÿæˆå™¨**

æ—¢ç„¶ç°åœ¨æˆ‘ä»¬å·²ç»çŸ¥é“äº†ç”Ÿæˆå™¨å†…éƒ¨æ‹¥æœ‰èƒ½å¤Ÿå¤šæ¬¡å¯åŠ¨å’Œæš‚åœä»£ç æ‰§è¡Œçš„å¼ºå¤§èƒ½åŠ›ï¼Œé‚£ä¹ˆå°†å®ƒç”¨äºå¼‚æ­¥ç¼–ç¨‹ä¸­ä¹Ÿä¾¿æ˜¯ç†æ‰€å½“ç„¶çš„äº‹æƒ…äº†ã€‚å…ˆæ¥çœ‹ä¸€ä¸ªå¼‚æ­¥è¿­ä»£ç”Ÿæˆå™¨çš„ä¾‹å­ã€‚

```js
const request = require('request')

const foo = function () {
    request('https://cosmos-alien.com/some.url', (err, response, data) => {
        if (err) it.throw(err)
        if (response.statusCode === 200) {
            it.next(data)
        }
    })
}

const main = function *() {
    try {
        let result = yield foo()
        console.log(result)
    }
    catch (err) {
        console.error(err)
    }
}

let it = main()

it.next()
```

è¿™ä¸ªä¾‹å­çš„é€»è¾‘å¾ˆç®€å•ï¼Œè°ƒç”¨ `it.next()` åç”Ÿæˆå™¨å¯åŠ¨ï¼Œé‡åˆ° `yield` æ—¶ç”Ÿæˆå™¨æš‚åœè¿è¡Œï¼Œä½†æ­¤æ—¶ `foo` å‡½æ•°å·²ç»æ‰§è¡Œå³ç½‘ç»œè¯·æ±‚å·²ç»å‘å‡ºï¼Œç­‰åˆ°æœ‰å“åº”ç»“æœæ—¶å¦‚æœå‡ºé”™åˆ™è°ƒç”¨ `it.throw(err)` å°†é”™è¯¯æŠ›å›ç”Ÿæˆå™¨å†…éƒ¨ç”± `try..catch` åŒæ­¥æ•è·ï¼Œå¦åˆ™å°†è¿”å›çš„ `data` ä½œä¸ºä¼ å›ç”Ÿæˆå™¨çš„å€¼åœ¨æ¢å¤æ‰§è¡Œçš„åŒæ—¶å°† `data` èµ‹å€¼ç»™å˜é‡ `result` ï¼Œæœ€åæ‰“å° `result` å¾—åˆ°æˆ‘ä»¬æƒ³è¦çš„ç»“æœã€‚ 

åœ¨ ES6 ä¸­æœ€å®Œç¾çš„ä¸–ç•Œå°±æ˜¯ç”Ÿæˆå™¨ ( çœ‹ä¼¼åŒæ­¥çš„å¼‚æ­¥ä»£ç  ) å’Œ Promise ( å¯ä¿¡ä»»å¯ç»„åˆ ) çš„ç»“åˆï¼Œå› æ­¤æˆ‘ä»¬ç°åœ¨å†æ¥çœ‹ä¸€ä¸ªç”±ç”Ÿæˆå™¨ + Promise å®ç°å¼‚æ­¥æ“ä½œçš„ä¾‹å­ã€‚

```js
const axios = require('axios')

const foo = function () {
    return axios({
        method: 'GET',
        url: 'https://cosmos-alien.com/some.url'
    })
}

const main = function *() {
    try {
        let result = yield foo()
        console.log(result)
    }
    catch (err) {
        console.error(err)
    }
}

let it = main()

let p = it.next().value

p.then((data) => {
    it.next(data)
}, (err) => {
    it.throw(err)
})
```

è¿™ä¸ªä¾‹å­è·Ÿå‰é¢å¼‚æ­¥è¿­ä»£ç”Ÿæˆå™¨çš„ä¾‹å­å‡ ä¹æ˜¯å·®ä¸å¤šçš„ï¼Œå”¯ä¸€ä¸åŒçš„å°±æ˜¯ `yield` ä¼ é€’å‡ºå»çš„æ˜¯ä¸€ä¸ª `promise` å¯¹è±¡ï¼Œä¹‹åæˆ‘ä»¬åœ¨ `then(..)` ä¸­æ¥æ¢å¤æ‰§è¡Œç”Ÿæˆå™¨é‡Œä¸‹ä¸€æ­¥çš„æ“ä½œæˆ–æ˜¯æŠ›å‡ºä¸€ä¸ªé”™è¯¯ã€‚

**ç”Ÿæˆå™¨å·¥ä½œåŸç†**

åœ¨è®²äº†é‚£ä¹ˆå¤šå…³äº generator ç”Ÿæˆå™¨çš„ä½¿ç”¨åï¼Œç›¸ä¿¡è¯»è€…ä¹Ÿè·Ÿæˆ‘ä¸€æ ·æƒ³çŸ¥é“ç”Ÿæˆå™¨ç©¶ç«Ÿæ˜¯å¦‚ä½•å®ç°èƒ½å¤Ÿæ§åˆ¶å‡½æ•°å†…éƒ¨ä»£ç çš„æš‚åœå’Œå¯åŠ¨ï¼Œä»è€Œå½¢æˆé˜»å¡åŒæ­¥çš„æ•ˆæœã€‚

æˆ‘ä»¬å…ˆæ¥ç®€å•äº†è§£ä¸‹æœ‰é™çŠ¶æ€æœº ( FSM ) è¿™ä¸ªæ¦‚å¿µï¼Œç»´åŸºç™¾ç§‘ä¸Šç»™å‡ºçš„è§£é‡Šæ˜¯è¡¨ç¤ºæœ‰é™ä¸ªçŠ¶æ€ä»¥åŠåœ¨è¿™äº›çŠ¶æ€ä¹‹é—´çš„è½¬ç§»å’ŒåŠ¨ä½œç­‰è¡Œä¸ºçš„æ•°å­¦æ¨¡å‹ã€‚ç®€å•çš„æ¥è¯´ï¼Œå®ƒæœ‰ä¸‰ä¸ªä¸»è¦ç‰¹å¾ï¼š

1. çŠ¶æ€æ€»æ•° ( state ) æ˜¯æœ‰é™çš„
2. ä»»ä¸€æ—¶åˆ»ï¼Œåªå¤„åœ¨ä¸€ç§çŠ¶æ€ä¹‹ä¸­
3. æŸç§æ¡ä»¶ä¸‹ï¼Œä¼šä»ä¸€ç§çŠ¶æ€è½¬å˜ ( transition ) åˆ°å¦ä¸€ç§çŠ¶æ€

å…¶å®ç”Ÿæˆå™¨å°±æ˜¯é€šè¿‡æš‚åœè‡ªå·±çš„ä½œç”¨åŸŸ / çŠ¶æ€æ¥å®ç°å®ƒçš„é­”æ³•çš„ï¼Œä¸‹é¢æˆ‘ä»¬å°±ä»¥ä¸Šæ–‡çš„ç”Ÿæˆå™¨ + Promise çš„ä¾‹å­ä¸ºåŸºç¡€ï¼Œç”¨æœ‰é™çŠ¶æ€æœºçš„æ–¹å¼æ¥é˜è¿°ç”Ÿæˆå™¨çš„åŸºæœ¬å·¥ä½œåŸç†ã€‚

```js
let stateRequest = {
    done: false,
    transition(message) {
        this.state = this.stateResult
        console.log(message)
        // state 1
        return foo()
    }
}

let stateResult = {
    done: true,
    transition(data) {
        // state 2
        let result = data
        console.log(result)
    }
}

let stateError = {
    transition(err) {
        // state 3
        console.error(err)
    }
}

let it = {
    init() {
        this.stateRequest = Object.create(stateRequest)
        this.stateResult = Object.create(stateResult)
        this.stateError = Object.create(stateError)
        this.state = this.stateRequest
    },
    next(data) {
        if (this.state.done) {
            return {
                done: true,
                value: undefined
            }
        } else {
            return {
                done: this.state.done,
                value: this.state.transition.call(this, data)
            }
        }
    },
    throw(err) {
        return {
            done: true,
            value: this.stateError.transition(err)
        }
    }
}

it.init()
it.next('The request begins !')
```

åœ¨è¿™é‡Œæˆ‘ä½¿ç”¨äº†è¡Œä¸ºå§”æ‰˜æ¨¡å¼å’ŒçŠ¶æ€æ¨¡å¼å®ç°äº†ä¸€ä¸ªç®€å•çš„æœ‰é™çŠ¶æ€æœºï¼Œè€Œå®ƒå´å±•ç°äº†ç”Ÿæˆå™¨ä¸­æ ¸å¿ƒéƒ¨åˆ†çš„å·¥ä½œåŸç†ï¼Œä¸‹é¢æˆ‘ä»¬æ¥é€æ­¥åˆ†æå®ƒæ˜¯å¦‚ä½•è¿è¡Œçš„ã€‚

é¦–å…ˆè¿™é‡Œæˆ‘ä»¬è‡ªå·±åˆ›å»ºçš„ `it` å¯¹è±¡å°±ç›¸å½“äºç”Ÿæˆå™¨å‡½æ•°æ‰§è¡Œåè¿”å›çš„è¿­ä»£å™¨å¯¹è±¡ï¼Œæˆ‘ä»¬æŠŠä¸Šæ–‡ç”Ÿæˆå™¨ + Promise ç¤ºä¾‹ä¸­çš„ `main` å‡½æ•°ä»£ç åˆ†ä¸ºäº†ä¸‰ä¸ªçŠ¶æ€å¹¶å°†è·Ÿè¯¥çŠ¶æ€æœ‰å…³çš„è¡Œä¸ºå°è£…åˆ°äº† `stateRequest` ã€`stateResult` ã€`stateError` ä¸‰ä¸ªå¯¹è±¡ä¸­ã€‚ç„¶åæˆ‘ä»¬å†è°ƒç”¨ `init(..)` å°† `it` å¯¹è±¡ä¸Šçš„è¡Œä¸ºå§”æ‰˜åˆ°è¿™ä¸‰ä¸ªå¯¹è±¡ä¸Šå¹¶åˆå§‹åŒ–å½“å‰çš„çŠ¶æ€å¯¹è±¡ã€‚åœ¨å‡†å¤‡å·¥ä½œå®Œæˆåè°ƒç”¨ `next(..)` å¯åŠ¨ç”Ÿæˆå™¨ï¼Œè¿™ä¸ªæ—¶å€™æˆ‘ä»¬å°±è¿›å…¥äº†çŠ¶æ€ä¸€ï¼Œå³æ‰§è¡Œ `foo` å‡½æ•°å‘å‡ºç½‘ç»œè¯·æ±‚ã€‚åœ¨ `foo` å‡½æ•°å†…éƒ¨å½“å¾—åˆ°è¯·æ±‚å“åº”æ•°æ®åå°±æ‰§è¡Œ `it.next(data)` è§¦å‘çŠ¶æ€æœºå†…éƒ¨çš„çŠ¶æ€æ”¹å˜ï¼Œæ­¤æ—¶æ‰§è¡ŒçŠ¶æ€äºŒå†…éƒ¨çš„ä»£ç å³æ‰“å°ç½‘ç»œè¯·æ±‚è¿”å›çš„ç»“æœã€‚å¦‚æœç½‘ç»œè¯·æ±‚ä¸­å‡ºç°é”™è¯¯å°±ä¼šæ‰§è¡Œ `it.throw(err)` ï¼Œè¿™ä¸ªæ—¶å€™çš„çŠ¶æ€å°±ä¼šè½¬æ¢åˆ°çŠ¶æ€ä¸‰å³é”™è¯¯å¤„ç†çŠ¶æ€ã€‚

åœ¨è¿™é‡Œæˆ‘ä»¬ä¼¼ä¹å¿½ç•¥äº†ä¸€ä¸ªå¾ˆé‡è¦çš„åœ°æ–¹ï¼Œå°±æ˜¯ç”Ÿæˆå™¨æ˜¯å¦‚ä½•åšåˆ°å°†å…¶å†…éƒ¨çš„ä»£ç åˆ†ä¸ºå¤šä¸ªçŠ¶æ€çš„ï¼Œå½“ç„¶æˆ‘ä»¬çŸ¥é“è¿™è‚¯å®šæ˜¯ `yield` è¡¨è¾¾å¼çš„åŠŸåŠ³ï¼Œä½†æ˜¯å…¶å†…éƒ¨åˆæ˜¯æ€ä¹ˆå®ç°çš„å‘¢ï¼Ÿç”±äºæœ¬äººèƒ½åŠ›è¿˜ä¸å¤Ÿï¼Œè€Œä¸”è¿˜æœ‰å¾ˆå¤šä¸œè¥¿æ¥ä¸åŠå»å­¦ä¹ å’Œäº†è§£ï¼Œå› æ­¤æš‚æ—¶æ— æ³•è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œä½†æˆ‘è¿˜æ˜¯æ„¿æ„æŠŠè¿™ä¸ªé—®é¢˜æå‡ºæ¥ï¼Œå¦‚æœè¯»è€…ç¡®å®æœ‰å…´è¶£èƒ½å¤Ÿé€šè¿‡æŸ¥é˜…èµ„æ–™æ‰¾åˆ°ç­”æ¡ˆæˆ–è€…å·²ç»çŸ¥é“å®ƒçš„åŸç†è¿˜æ˜¯å¯ä»¥åˆ†äº«å‡ºæ¥ï¼Œæ¯•ç«Ÿç»å†è¿™æ ·åˆ¨æ ¹é—®åº•çš„è¿‡ç¨‹è¿˜æ˜¯æ»¡æœ‰è¶£çš„ã€‚

#### async / await

ç»ˆäºè®²åˆ°æœ€åä¸€ä¸ªå¼‚æ­¥è¯­æ³•äº†ï¼Œä½œä¸ºå‹è½´çš„èº«ä»½å‡ºåœºï¼Œæ®è¯´ async / await æ˜¯ JS å¼‚æ­¥ç¼–ç¨‹ä¸­çš„ç»ˆæè§£å†³æ–¹æ¡ˆã€‚è¯ä¸å¤šè¯´ï¼Œå…ˆç›´æ¥ä¸Šä»£ç çœ‹çœ‹å®ƒçš„åŸºæœ¬ç”¨æ³•ï¼Œç„¶åæˆ‘ä»¬å†æ¥æ¢è®¨ä¸€ä¸‹å®ƒçš„å®ç°åŸç†ã€‚

```js
const foo = function (time) {
    return new Promise((resolve, reject) => {
        setTimeout(() => {
            resolve(time + 200)
        }, time)
    })
}

const step1 = time => foo(time)
const step2 = time => foo(time) 
const step3 = time => foo(time)

const main = async function () {
    try {
        console.time('run')
        let time1 = 200
        let time2 = await step1(time1)
        let time3 = await step2(time2)
        await step3(time3)
        console.log(`All steps took ${time1 + time2 + time3} ms.`)
        console.timeEnd('run')
    } catch(err) {
        console.error(err)
    }
}

main()
// All steps took 1200 ms.
// run: 1222.87939453125ms
```

æˆ‘ä»¬å¯ä»¥çœ‹åˆ° async å‡½æ•°è·Ÿç”Ÿæˆå™¨å‡½æ•°æä¸ºç›¸ä¼¼ï¼Œåªæ˜¯å°†ä¹‹å‰çš„ `*` å˜æˆäº† `async` ï¼Œ`yield` å˜æˆäº† `await` ã€‚å…¶å®å®ƒå°±æ˜¯ä¸€ä¸ªèƒ½å¤Ÿè‡ªåŠ¨æ‰§è¡Œçš„ generator å‡½æ•°ï¼Œæˆ‘ä»¬ä¸ç”¨å†é€šè¿‡æ‰‹åŠ¨æ‰§è¡Œ `it.next(..)` æ¥æ§åˆ¶ç”Ÿæˆå™¨å‡½æ•°çš„æš‚åœä¸å¯åŠ¨ã€‚

`await` å¸®æˆ‘ä»¬åšåˆ°äº†åœ¨åŒæ­¥é˜»å¡ä»£ç çš„åŒæ—¶è¿˜èƒ½å¤Ÿç›‘å¬ Promise å¯¹è±¡çš„å†³è®®ï¼Œä¸€æ—¦ `promise` å†³è®®ï¼ŒåŸæœ¬æš‚åœæ‰§è¡Œçš„ async å‡½æ•°å°±ä¼šæ¢å¤æ‰§è¡Œã€‚è¿™ä¸ªæ—¶å€™å¦‚æœå†³è®®æ˜¯ `resolve` ï¼Œé‚£ä¹ˆè¿”å›çš„ç»“æœå°±æ˜¯ `resolve` å‡ºæ¥çš„å€¼ã€‚å¦‚æœå†³è®®æ˜¯ `reject` ï¼Œæˆ‘ä»¬å°±å¿…é¡»ç”¨ `try..catch` æ¥æ•è·è¿™ä¸ªé”™è¯¯ï¼Œå› ä¸ºå®ƒç›¸å½“äºæ‰§è¡Œäº† `it.throw(err)` ã€‚

ä¸‹é¢ç›´æ¥ç»™å‡ºä¸€ç§ä¸»æµçš„ async / await è¯­æ³•ç‰ˆæœ¬çš„å®ç°ä»£ç ï¼š

```js
const runner = function (gen) {
    return new Promise((resolve, reject) => {
        var it = gen()
        const step = function (execute) {
            try {
                var next = execute()
            } catch (err) {
                reject(err)
            }
            
            if (next.done) return resolve(next.value)
            
            Promise.resolve(next.value)
            .then(val => step(() => it.next(val)))
            .catch(err => step(() => it.throw(err)))
        }
        step(() => it.next())
    })
}

async function fn() {
    // ...
}

// ç­‰åŒäº

function fn() {
    const gen = function *() {
        // ...
    }
    runner(gen)
}
```

ä»ä¸Šé¢çš„ä»£ç æˆ‘ä»¬å¯ä»¥çœ‹å‡º async å‡½æ•°æ‰§è¡Œåè¿”å›çš„æ˜¯ä¸€ä¸ª Promise å¯¹è±¡ï¼Œç„¶åä½¿ç”¨é€’å½’çš„æ–¹æ³•å»è‡ªåŠ¨æ‰§è¡Œç”Ÿæˆå™¨å‡½æ•°çš„æš‚åœä¸å¯åŠ¨ã€‚å¦‚æœè°ƒç”¨ `it.next().value` ä¼ å‡ºæ¥çš„æ˜¯ä¸€ä¸ª `promise` ï¼Œåˆ™ç”¨ `Promise.resolve()` æ–¹æ³•å°†å…¶å¼‚æ­¥å±•å¼€ï¼Œå½“è¿™ä¸ª `promise` å†³è®®æ—¶å°±å¯ä»¥é‡æ–°å¯åŠ¨æ‰§è¡Œç”Ÿæˆå™¨å‡½æ•°æˆ–è€…æŠ›å‡ºä¸€ä¸ªé”™è¯¯è¢« `try..catch` æ‰€æ•è·å¹¶æœ€ç»ˆåœ¨ async å‡½æ•°è¿”å›çš„ Promise å¯¹è±¡çš„é”™è¯¯å¤„ç†å‡½æ•°ä¸­å¤„ç†ã€‚

**å…³äº async / await çš„æ‰§è¡Œé¡ºåº**

ä¸‹é¢ç»™å‡ºä¸€é“å…³äº async / await æ‰§è¡Œé¡ºåºçš„ç»å…¸é¢è¯•é¢˜ï¼Œç½‘ä¸Šç»™å‡ºçš„è§£é‡Šç»™æˆ‘æ„Ÿè§‰ä¼¼ä¹å¾ˆå«ç³Šã€‚åœ¨è¿™é‡Œæˆ‘ä»¬ç»“åˆä¸Šæ–‡æ‰€è®²çš„ generator å‡½æ•°è¿è¡Œæœºåˆ¶å’Œ async / await å®ç°åŸç†æ¥å…·ä½“é˜è¿°ä¸‹ä¸ºä»€ä¹ˆæ‰§è¡Œé¡ºåºæ˜¯è¿™æ ·çš„ã€‚

```js
async function async1(){
    console.log('async1 start')
    await async2()
    console.log('async1 end')
}

async function async2(){
    console.log('async2')
}

console.log('script start')

setTimeout(() => {
    console.log('setTimeout')
})

async1()

new Promise((resolve) => {
    console.log('promise1')
    resolve()
})
.then(() => {
    console.log('promise2')
})

console.log('script end')
```

å°†è¿™æ®µä»£ç æ”¾åœ¨æµè§ˆå™¨ä¸­è¿è¡Œï¼Œæœ€ç»ˆçš„ç»“æœè¿™æ ·çš„ï¼š

```js
script start
async1 start
async2
promise1
script end
promise2
async1 end
setTimeout
```

å…¶å®æœ€ä¸»è¦çš„åœ°æ–¹è¿˜æ˜¯è¦åˆ†æ¸…åœ¨æ‰§è¡Œæ ˆä¸­åŒæ­¥æ‰§è¡Œçš„ä»»åŠ¡ä¸äº‹ä»¶é˜Ÿåˆ—ä¸­å¼‚æ­¥æ‰§è¡Œçš„ä»»åŠ¡ã€‚é¦–å…ˆæˆ‘ä»¬æ‰§è¡ŒåŒæ­¥ä»»åŠ¡ï¼Œæ‰“å° `script start` ï¼Œè°ƒç”¨å‡½æ•° `async1` ï¼Œåœ¨æˆ‘ä»¬é‡åˆ° `await` è¡¨è¾¾å¼åå°±ä¼šæš‚åœå‡½æ•° `async1` çš„æ‰§è¡Œã€‚å› ä¸ºåœ¨è¿™é‡Œå®ƒç›¸å½“äº `yield async2()` ï¼Œæ ¹æ®ä¸Šæ–‡çš„ async / await åŸç†å®ç°ä»£ç å¯ä»¥çœ‹å‡ºï¼Œå½“è‡ªåŠ¨è°ƒç”¨ `it.next()` æ—¶é‡åˆ°ç¬¬ä¸€ä¸ª `yield` åä¼šæš‚åœæ‰§è¡Œï¼Œä½†æ­¤æ—¶å‡½æ•° `async2` å·²ç»æ‰§è¡Œã€‚ä¸Šæ–‡è¿˜æåˆ°è¿‡ `async` å‡½æ•°åœ¨æ‰§è¡Œå®Œåä¼šè¿”å›ä¸€ä¸ª Promise å¯¹è±¡ï¼Œæ•…æ­¤æ—¶ `it.next().value` çš„å€¼å°±æ˜¯ä¸€ä¸ª `promise` ã€‚æ¥ä¸‹æ¥è¦è®²çš„å°±æ˜¯é‡ç‚¹å•¦ ï¼ï¼ï¼

**æˆ‘ä»¬ç”¨ `Promise.resolve()` å»å¼‚æ­¥åœ°å±•å¼€ä¸€ä¸ª `promise` ï¼Œå› æ­¤ç¬¬ä¸€ä¸ªæ”¾å…¥äº‹ä»¶é˜Ÿåˆ—ä¸­çš„å¾®é˜Ÿåˆ—ä»»åŠ¡å…¶å®å°±æ˜¯è¿™ä¸ª `promise` ã€‚ä¹‹åæˆ‘ä»¬å†ç»§ç»­è¿è¡Œæ‰§è¡Œæ ˆä¸­å‰©ä¸‹çš„åŒæ­¥ä»»åŠ¡ï¼Œæ­¤æ—¶æ‰“å°å‡º `promise1` å’Œ `script end` ï¼ŒåŒæ—¶ç¬¬äºŒä¸ªå¼‚æ­¥ä»»åŠ¡è¢«åŠ å…¥åˆ°äº‹ä»¶é˜Ÿåˆ—ä¸­çš„å¾®é˜Ÿåˆ—ã€‚åŒæ­¥çš„ä»»åŠ¡æ‰§è¡Œå®Œäº†ï¼Œç°åœ¨æ¥æ‰§è¡Œå¼‚æ­¥ä»»åŠ¡ï¼Œé¦–å…ˆå°†å¾®é˜Ÿåˆ—ä¸­ç¬¬ä¸€ä¸ªæ”¾å…¥çš„é‚£ä¸ª `promise` æ‹¿åˆ°æ‰§è¡Œæ ˆä¸­å»æ‰§è¡Œï¼Œè¿™ä¸ªæ—¶å€™ä¹‹å‰ `Promise.resolve()` åé¢æ³¨å†Œçš„å›è°ƒä»»åŠ¡æ‰ä¼šä½œä¸ºç¬¬ä¸‰ä¸ªä»»åŠ¡åŠ å…¥åˆ°äº‹ä»¶é˜Ÿåˆ—ä¸­çš„å¾®é˜Ÿåˆ—é‡Œå»ã€‚ç„¶åæˆ‘ä»¬æ‰§è¡Œå¾®é˜Ÿåˆ—ä¸­çš„ç¬¬äºŒä¸ªä»»åŠ¡ï¼Œæ‰“å° `promise2`ï¼Œå†æ‰§è¡Œç¬¬ä¸‰ä¸ªä»»åŠ¡å³è°ƒç”¨ `step(() => it.next(val))` æ¢å¤ `async` å‡½æ•°çš„æ‰§è¡Œï¼Œæ‰“å° `async1 end` ã€‚æœ€åï¼Œå› ä¸ºå¾®é˜Ÿåˆ—æ€»æ˜¯æŠ¢å å¼çš„åœ¨å®é˜Ÿåˆ—ä¹‹å‰æ’å…¥æ‰§è¡Œï¼Œæ•…åªæœ‰å½“å¾®é˜Ÿåˆ—ä¸­æ²¡æœ‰äº†ä»»åŠ¡ä»¥åï¼Œå®é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡æ‰ä¼šå¼€å§‹æ‰§è¡Œï¼Œæ•…æœ€ç»ˆæ‰“å°å‡º `setTimeout` ã€‚**   

### å¸¸è§å¼‚æ­¥æ¨¡å¼

> åœ¨è½¯ä»¶å¼€å‘ä¸­æœ‰ç€è®¾è®¡æ¨¡å¼è¿™ä¸€ä¸“ä¸šæœ¯è¯­ï¼Œé€šä¿—ä¸€ç‚¹æ¥è®²è®¾è®¡æ¨¡å¼å…¶å®å°±æ˜¯åœ¨æŸç§åœºåˆä¸‹é’ˆå¯¹æŸä¸ªé—®é¢˜çš„ä¸€ç§è§£å†³æ–¹æ¡ˆã€‚

åœ¨ JS å¼‚æ­¥ç¼–ç¨‹çš„ä¸–ç•Œé‡Œï¼Œå¾ˆå¤šæ—¶å€™æˆ‘ä»¬ä¹Ÿä¼šé‡åˆ°å› ä¸ºæ˜¯å¼‚æ­¥æ“ä½œè€Œå‡ºç°çš„ç‰¹å®šé—®é¢˜ï¼Œè€Œé’ˆå¯¹è¿™äº›é—®é¢˜æ‰€æå‡ºçš„è§£å†³æ–¹æ¡ˆ ( é€»è¾‘ä»£ç  ) å°±æ˜¯å¼‚æ­¥ç¼–ç¨‹çš„æ ¸å¿ƒï¼Œä¼¼ä¹åœ¨è¿™é‡Œå®ƒè·Ÿè®¾è®¡æ¨¡å¼çš„æ¦‚å¿µå¾ˆç›¸åƒï¼Œæ‰€ä»¥æˆ‘æŠŠå®ƒå«åšå¼‚æ­¥æ¨¡å¼ã€‚ä¸‹é¢æˆ‘å°†ä»‹ç»å‡ ç§å¸¸è§çš„å¼‚æ­¥æ¨¡å¼åœ¨å®é™…åœºæ™¯ä¸‹çš„åº”ç”¨ã€‚

**å¹¶å‘äº¤äº’æ¨¡å¼**

å½“æˆ‘ä»¬åœ¨åŒæ—¶æ‰§è¡Œå¤šä¸ªå¼‚æ­¥ä»»åŠ¡æ—¶ï¼Œè¿™äº›ä»»åŠ¡è¿”å›å“åº”ç»“æœçš„æ—¶é—´å¾€å¾€æ˜¯ä¸ç¡®å®šçš„ï¼Œå› è€Œä¼šäº§ç”Ÿä»¥ä¸‹ä¸¤ç§å¸¸è§çš„éœ€æ±‚ï¼š

1. å¤šä¸ªå¼‚æ­¥ä»»åŠ¡åŒæ—¶æ‰§è¡Œï¼Œç­‰å¾…æ‰€æœ‰ä»»åŠ¡éƒ½è¿”å›ç»“æœåæ‰å¼€å§‹è¿›è¡Œä¸‹ä¸€æ­¥çš„æ“ä½œã€‚
2. å¤šä¸ªå¼‚æ­¥ä»»åŠ¡åŒæ—¶æ‰§è¡Œï¼Œåªè¿”å›æœ€å…ˆå®Œæˆå¼‚æ­¥æ“ä½œçš„é‚£ä¸ªä»»åŠ¡çš„ç»“æœç„¶åå†è¿›è¡Œä¸‹ä¸€æ­¥çš„æ“ä½œã€‚

**åœºæ™¯ä¸€ï¼š**

åŒæ—¶è¯»å–å¤šä¸ªå«æœ‰è‹±æ–‡æ–‡ç« çš„ `txt` æ–‡ä»¶å†…å®¹ï¼Œè®¡ç®—å…¶ä¸­å•è¯ `of` çš„ä¸ªæ•°ã€‚

1. ç­‰å¾…æ‰€æœ‰æ–‡ä»¶ä¸­çš„ `of` ä¸ªæ•°è®¡ç®—å®Œæ¯•ï¼Œå†è®¡ç®—è¾“å‡ºæ€»çš„ `of` æ•°ã€‚
2. ç›´æ¥è¾“å‡ºç¬¬ä¸€ä¸ªè®¡ç®—å®Œ `of` çš„ä¸ªæ•°ã€‚

```js
const fs = require('fs')
const path = require('path')

const addAll = (result) => console.log(result.reduce((prev, cur) => prev + cur))

let dir = path.join(__dirname, 'files')

fs.readdir(dir, (err, files) => {
    if (err) return console.error(err)
    let promises = files.map((file) => {
        return new Promise((resolve, reject) => {
            let fileDir = path.join(dir, file)
            fs.readFile(fileDir, { encoding: 'utf-8' }, (err, data) => {
                if (err) reject(err)
                let count = 0
                data.split(' ').map(word => word === 'of' ? count++ : null)
                resolve(count)
            })
        })
    })
    Promise.all(promises).then(result => addAll(result)).catch(err => console.error(err))
    Promise.race(promises).then(result => console.log(result)).catch(err => console.error(err))
})
```

**å¹¶å‘æ§åˆ¶æ¨¡å¼**

æœ‰æ—¶å€™æˆ‘ä»¬ä¼šé‡åˆ°å¤§é‡å¼‚æ­¥ä»»åŠ¡å¹¶å‘æ‰§è¡Œè€Œä¸”è¿˜è¦å¤„ç†è¿”å›æ•°æ®çš„æƒ…å†µï¼Œå³ä½¿æ‹¥æœ‰äº‹ä»¶å¾ªç¯ ( Event Loop ) æœºåˆ¶ï¼Œåœ¨å¹¶å‘é‡è¿‡é«˜çš„æƒ…å†µä¸‹ç¨‹åºä»ç„¶ä¼šå´©æºƒï¼Œæ‰€ä»¥è¿™ä¸ªæ—¶å€™å°±åº”è¯¥è€ƒè™‘å¹¶å‘æ§åˆ¶ã€‚

**åœºæ™¯äºŒï¼š**

åˆ©ç”¨ Node.js å®ç°å›¾ç‰‡çˆ¬è™«ï¼Œæ§åˆ¶çˆ¬å–æ—¶çš„å¹¶å‘é‡ã€‚ä¸€æ˜¯é˜²æ­¢ IP è¢«å°æ‰ ï¼ŒäºŒæ˜¯é˜²æ­¢å¹¶å‘è¯·æ±‚é‡è¿‡é«˜ä½¿ç¨‹åºå´©æºƒã€‚

```js
const fs = require('fs')
const path = require('path')
const request = require('request')
const cheerio = require('cheerio')

const target = `http://www.zimuxia.cn/${encodeURIComponent('æˆ‘ä»¬çš„ä½œå“')}`

const isError = (err, res) => (err || res.statusCode !== 200) ? true : false

const getImgUrls = function (pages) {
    return new Promise((resolve) => {
        let limit = 8, number = 0, imgUrls = []
        const recursive = async function () {
            pages = pages - limit
            limit = pages >= 0 ? limit : (pages + limit)
            let arr = []
            for (let i = 1; i <=limit; i++) {
                arr.push(
                    new Promise((resolve) => {
                        request(target + `?set=${number++}`, (err, res, data) => {
                            if (isError(err, res)) return console.log('Request failed.')
                            let $ = cheerio.load(data)
                            $('.pg-page-wrapper img').each((i, el) => {
                                let imgUrl = $(el).attr('data-cfsrc')
                                imgUrls.push(imgUrl)
                                resolve()
                            })
                        })
                    })
                )
            }
            await Promise.all(arr)
            if (limit === 8) return recursive()
            resolve(imgUrls)
        }
        recursive()
    })
}

const downloadImages = function (imgUrls) {
    console.log('\n Start to download images. \n')
    let limit = 5
    const recursive = async function () {
        limit = imgUrls.length - limit >= 0 ? limit : imgUrls.length
        let arr = imgUrls.splice(0, limit)
        let promises = arr.map((url) => {
            return new Promise((resolve) => {
                let imgName = url.split('/').pop()
                let imgPath = path.join(__dirname, `images/${imgName}`)
                request(url)
                .pipe(fs.createWriteStream(imgPath))
                .on('close', () => {
                    console.log(`${imgName} has been saved.`)
                    resolve()
                })
            })
        })
        await Promise.all(promises)
        if (imgUrls.length) return recursive()
        console.log('\n All images have been downloaded.')
    }
    recursive()
}

request({
    url: target,
    method: 'GET'
}, (err, res, data) => {
    if (isError(err, res)) return console.log('Request failed.')
    let $ = cheerio.load(data)
    let pageNum = $('.pg-pagination li').length
    console.log('Start to get image urls...')
    getImgUrls(pageNum)
    .then((result) => {
        console.log(`Finish getting image urls and the number of them is ${result.length}.`)
        downloadImages(result)
    })
})
```

**å‘å¸ƒ / è®¢é˜…æ¨¡å¼**

æˆ‘ä»¬å‡å®šï¼Œå­˜åœ¨ä¸€ä¸ª"ä¿¡å·ä¸­å¿ƒ"ï¼Œå½“æŸä¸ªä»»åŠ¡æ‰§è¡Œå®Œæˆï¼Œå°±å‘ä¿¡å·ä¸­å¿ƒ"å‘å¸ƒ" ( publish ) ä¸€ä¸ªä¿¡å·ï¼Œå…¶ä»–ä»»åŠ¡å¯ä»¥å‘ä¿¡å·ä¸­å¿ƒ"è®¢é˜…" ( subscribe ) è¿™ä¸ªä¿¡å·ï¼Œä»è€ŒçŸ¥é“ä»€ä¹ˆæ—¶å€™è‡ªå·±å¯ä»¥å¼€å§‹æ‰§è¡Œï¼Œå½“ç„¶æˆ‘ä»¬è¿˜å¯ä»¥å–æ¶ˆè®¢é˜…è¿™ä¸ªä¿¡å·ã€‚

æˆ‘ä»¬å…ˆæ¥å®ç°ä¸€ä¸ªç®€å•çš„å‘å¸ƒè®¢é˜…å¯¹è±¡ï¼š

```js
class Listener {
    constructor() {
        this.eventList = {}
    }
    on(event, fn) {
        if (!this.eventList[event]) this.eventList[event] = []
        if (fn.name) {
            let obj = {}
            obj[fn.name] = fn
            fn = obj
        }
        this.eventList[event].push(fn)
    }
    remove(event, fn) {
        if (!fn) return console.error('Choose a named function to remove!')
        this.eventList[event].map((item, index) => {
            if (typeof item === 'object' && item[fn.name]) {
                this.eventList[event].splice(index, 1)
            }
        })
    }
    emit(event, data) {
        this.eventList[event].map((fn) => {
            if (typeof fn === 'object') {
                Object.values(fn).map((f) => f.call(null, data))
            } else {
                fn.call(null, data)
            }
        })
    }
}

let listener = new Listener()

function foo(data) { console.log('Hello ' + data) }

listener.on('click', (data) => console.log(data))

listener.on('click', foo)

listener.emit('click', 'RetroAstro')

// Hello
// Hello RetroAstro

listener.remove('click', foo)

listener.emit('click', 'Barry Allen')

// Barry Allen
```

**åœºæ™¯ä¸‰ï¼š**

ç›‘å¬ watch æ–‡ä»¶å¤¹ï¼Œå½“é‡Œé¢çš„æ–‡ä»¶æœ‰æ”¹åŠ¨æ—¶è‡ªåŠ¨å‹ç¼©è¯¥æ–‡ä»¶å¹¶ä¿å­˜åˆ° done æ–‡ä»¶å¤¹ä¸­ã€‚

```js
// gzip.js
const fs = require('fs')
const path = require('path')
const zlib = require('zlib')

const gzipFile = function (file) {
    let dir = path.join(__dirname, 'watch')
    fs.readdir(dir, (err, files) => {
        if (err) console.error(err)
        files.map((filename) => {
            let watchFile = path.join(dir, filename)
            fs.stat(watchFile, (err, stats) => {
                if (err) console.error(err)
                if (stats.isFile() && file === filename) {
                    let doneFile = path.join(__dirname, `done/${file}.gz`)
                    fs.createReadStream(watchFile)
                    .pipe(zlib.createGzip())
                    .pipe(fs.createWriteStream(doneFile))
                }
            })
        })
    })
}

module.exports = {
    gzipFile: gzipFile
}
```

å¼€å§‹ç›‘å¬ watch æ–‡ä»¶å¤¹ä¸­çš„æ–‡ä»¶

```js
// watch.js
const fs = require('fs')
const path = require('path')

const { gzipFile } = require('./gzip')
const { Listener } = require('./listener')

let listener = new Listener()

listener.on('gzip', (data) => gzipFile(data))

let dir = path.join(__dirname, 'watch')

let wait = true

fs.watch(dir, (event, filename) => {
    if (filename && event === 'change' && wait) {
        wait = false
        setTimeout(() => wait = true, 100)
        listener.emit('gzip', filename)
    }
})
```

### ç»“è¯­

å¯¹äº JavaScript å¼‚æ­¥ç¼–ç¨‹åœ¨è¿™é‡Œæˆ‘å°±è®²è¿™ä¹ˆå¤šäº†ï¼Œå½“ç„¶è¿˜æœ‰å¾ˆå¤šä¸œè¥¿è‡ªå·±æ²¡æœ‰äº†è§£å’Œå­¦ä¹ åˆ°ï¼Œå› æ­¤åœ¨æœ¬ç¯‡æ–‡ç« ä¸­æ²¡æœ‰æ¶‰åŠã€‚æœ€åè¿˜æ˜¯ç»™å‡ºä¸Šé¢ä¸‰ä¸ªåœºæ™¯ä»£ç çš„ [**GitHub åœ°å€**](https://github.com/RetroAstro/cosmos-blog/tree/master/posts/11) ï¼Œæ€»ä¹‹åœ¨å‰ç«¯å­¦ä¹ çš„è·¯ä¸Šè¿˜å¾—ç»§ç»­åŠ æ²¹å˜ ğŸ˜„ã€‚

---

å‚è€ƒä¹¦ç±åŠæ–‡ç« ï¼š

ã€Š ä½ ä¸çŸ¥é“çš„ JavaScript ã€‹(ä¸Š)  (ä¸­)

ã€Š JavaScript è®¾è®¡æ¨¡å¼ä¸å¼€å‘å®è·µ ã€‹

ã€Š Node.js å®æˆ˜ ã€‹( ç¬¬äºŒç‰ˆ )

&nbsp;&nbsp;[æ·±å…¥ç†è§£ JS äº‹ä»¶å¾ªç¯æœºåˆ¶ ( æµè§ˆå™¨ç¯‡ )](http://lynnelv.github.io/js-event-loop-browser)

&nbsp;&nbsp;[æ·±å…¥ç†è§£ JS äº‹ä»¶å¾ªç¯æœºåˆ¶ ( Node.js ç¯‡ )](http://lynnelv.github.io/js-event-loop-nodejs) 

&nbsp;&nbsp;[JavaScript å¼‚æ­¥ç¼–ç¨‹çš„å››ç§æ–¹æ³•](http://www.ruanyifeng.com/blog/2012/12/asynchronous%EF%BC%BFjavascript.html)

&nbsp;&nbsp;[å½»åº•ç†è§£ Promise åŸç†](https://segmentfault.com/a/1190000009478377#articleHeader4)

&nbsp;&nbsp;[async å‡½æ•°çš„å«ä¹‰å’Œç”¨æ³•](http://www.ruanyifeng.com/blog/2015/05/async.html)

&nbsp;&nbsp;[ä»æµè§ˆå™¨å¤šè¿›ç¨‹åˆ° JS å•çº¿ç¨‹ï¼ŒJS è¿è¡Œæœºåˆ¶æœ€å…¨é¢çš„ä¸€æ¬¡æ¢³ç†](https://segmentfault.com/a/1190000012925872)



